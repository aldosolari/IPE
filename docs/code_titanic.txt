#--- IMPORT TITANIC DATA ---# see https://hbiostat.org/data/repo/titanic5# and https://hbiostat.org/rflow/caserm(list=ls())library(readr)require(Hmisc)require(qreport)require(data.table)library(stringr)library(ggpubr)file <- tempfile()download.file('https://hbiostat.org/data/repo/titanic5.xlsx',               destfile=file)t5 <- csv.get('https://hbiostat.org/data/repo/titanic5.csv',              lowernames=TRUE, allow='_')g <- function(x)  if(is.character(x)) ifelse(trimws(x) == '', NA, x) else xt5 <- lapply(t5, g)setDT(t5)d <- copy(t5)setnames(d, 'dob_clean', 'dob')head(d)dd <- readxl::read_xlsx(file, sheet='Titanic5_metadata')setDT(dd)dd <- dd[, .(Variable, Description)]dd[, Variable := makeNames(tolower(Variable), allow='_')]dd[Variable == 'dob_clean', Variable := 'dob']dd[, writeLines(paste0(Variable, '\t: ', Description))]d[, dob := as.Date(dob, '%m/%d/%Y')]d[, table(is.na(age), is.na(dob))]d[, age := ifelse(is.na(age), age_f, age)]d[, .q(age_f, age_f_code) := NULL]pounds2dec <- function(price, check=FALSE) {  p <- strsplit(price, ' ')  if(check) prn(table(sapply(p, length)), 'Distribution of number of fields found')  p1 <- sapply(p, function(x) x[1])  p2 <- sapply(p, function(x) if(length(x) < 2) ' ' else x[2])  p3 <- sapply(p, function(x) if(length(x) < 3) ' ' else x[3])  if(check) {    prn(table(p1), 'Frequencies of occurrence of all 1st field values')    prn(table(p2), '2nd field')    prn(table(p3), '3rd field')    prn(table(substring(p1, 1, 1)),       'First letter of 1st field')    prn(table(substring(p2, nchar(p2))),  'Last letter of 2nd field')    prn(table(substring(p3, nchar(p3))),  'Last letter of 3rd field')  }  ps   <- cbind(p1, p2, p3)  pdec <- rep(0, length(p1))  g <- function(x, r) ifelse(grepl(r, x),                             as.numeric(gsub(r, '', x)), 0)  for(j in 1 : 3)  {    pj   <- ps[, j]    pdec <- pdec + g(pj, '£') + g(pj, 's') / 20 + g(pj, 'd') / (12 * 20)  }  pdec[is.na(price) | trimws(price) == ''] <- NA  if(check) print(data.table(price, pdec)[1:10])  pdec}d[, price := pounds2dec(price, check=TRUE)]all(names(d) %in% dd$Variable)labs          <- dd$Descriptionnames(labs)   <- dd$Variablelabs['age']   <- 'Age'            labs['price'] <- 'Ticket price'   labs['dob']   <- 'Date of birth'labs['sex']   <- 'Sex'd <- upData(d, labels=labs,            units=c(age='years', price='£'))titanic <- as.data.frame(d[,c("name","sex","age","survived","class","joined","ticket","price", "sibsp", "parch","job","occupation", "dob", "date_death","boat..body.", "url")])rm(d)rm(dd)rm(t5)rm(file)rm(g)rm(labs)rm(pounds2dec)titanic$ticketFreq <- ave(1:nrow(titanic), titanic$ticket, FUN=length)titanic$pricepp <- round(titanic$price / titanic$ticketFreq,1)titanic$price <- round(titanic$price,1)titanic$fsize <- 1 + titanic$sibsp + titanic$parchtitanic$title <- stringr::word(gsub('(.*, )|(\\..*)', '', titanic$name),1)titanic <- titanic[order(titanic$name),]readr::write_csv(as.data.frame(titanic), file = "titanic.csv")#--- EXPLORING DATA ---titanic_nomiss <- titanic[complete.cases(titanic$age),]titanic_nomiss$age <- floor(titanic_nomiss$age)titanic_agef <- titanic_nomiss[titanic_nomiss$sex=="female",]#--- BARPLOT ---#pdf("Figure_barplot.pdf")plot(table(titanic_agef$age), ylab="Frequency", main="age (female)")#dev.off()#--- HISTOGRAM ---cuts = seq(0,65,by=5)#pdf("Figure_hist.pdf")hist(titanic_agef$age, breaks = cuts, right = TRUE, include.lowest = TRUE, xlab="age (female)", main="")#dev.off()titanic_agef$age_class = cut(titanic_agef$age, include.lowest = TRUE, right = TRUE, breaks = cuts)table(titanic_agef$age_class, useNA = "ifany")cuts = c(seq(0,45,by=10), 65)#pdf("Figure_hist_wrong.pdf")hist(freq=T,titanic_agef$age, breaks = cuts, right = TRUE, include.lowest = TRUE, xlab="age (female)", main="")hist(freq=F,titanic_agef$age, breaks = cuts, right = TRUE, include.lowest = TRUE, xlab="age (female)", main="")#dev.off()titanic_agef$age_class = cut(titanic_agef$age, include.lowest = TRUE, right = TRUE, breaks = cuts)table(titanic_agef$age_class, useNA = "ifany")#--- BOXPLOT ---#pdf("Figure_boxplot.pdf")boxplot(titanic_agef$age, horizontal = T, xlab="age (female)")#dev.off()#pdf("Figure_boxplot2.pdf")boxplot(age ~ sex, titanic, horizontal = T)#dev.off()#--- OUTLIERS ---#pdf("Figure_skewed.pdf")hist(titanic$pricepp, xlab="price (per passenger)", main="")#dev.off()#pdf("Figure_outliers.pdf")plot(xlab="Price (per passenger)",ylab="Frequency",table(titanic$pricepp))#dev.off()class_survive_table <- prop.table(table( titanic$survived, titanic$class),2)rownames(class_survive_table) <- c("dead","alive")colnames(class_survive_table) <- c("1st","2nd","3rd")#pdf("Figure_mosaicraw.pdf")barplot(class_survive_table, main="",  beside =T)#dev.off()class_survive_table <- table(  titanic$class, titanic$survived)colnames(class_survive_table) <- c("dead","alive")rownames(class_survive_table) <- c("1st","2nd","3rd")#pdf("Figure_mosaic.pdf")mosaicplot(class_survive_table, color = TRUE, main="")#dev.off()class_survive_tableM <- table(  titanic$class[titanic$sex=="male"], titanic$survived[titanic$sex=="male"])colnames(class_survive_tableM) <- c("dead","alive")rownames(class_survive_tableM) <- c("1st","2nd","3rd")#pdf("Figure_mosaicM.pdf")mosaicplot(class_survive_tableM, main="male", color = TRUE)#dev.off()class_survive_tableF <- table(  titanic$class[titanic$sex=="female"], titanic$survived[titanic$sex=="female"])colnames(class_survive_tableF) <- c("dead","alive")rownames(class_survive_tableF) <- c("1st","2nd","3rd")#pdf("Figure_mosaicF.pdf")mosaicplot(class_survive_tableF, main="female", color = TRUE)#dev.off()#pdf("Figure_price_age.pdf")ggscatter(titanic, y = "pricepp", x = "age", add = "reg.line",  # Add regressin line          add.params = list(color = "blue")) #dev.off()#pdf("Figure_price_age_class.pdf")ggscatter(titanic, y = "pricepp", x = "age", add = "reg.line",            add.params = list(color = "blue")) + facet_grid(class ~ joined)#dev.off()